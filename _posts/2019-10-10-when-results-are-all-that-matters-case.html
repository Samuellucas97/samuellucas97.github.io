---
layout: post
title: 'When Results Are All That Matters: The Case of the Angora Fuzzer'
date: '2019-10-10T12:17:00.000+02:00'
author: Andreas Zeller
tags: popular
modified_time: '2019-10-17T18:11:41.291+02:00'
blogger_id: tag:blogger.com,1999:blog-8747085902902510837.post-666756311730643239
blogger_orig_url: https://andreas-zeller.blogspot.com/2019/10/when-results-are-all-that-matters-case.html
---

<em>by Andreas Zeller and Sascha Just; with Kai Greshake</em> <br /><h2>The Case</h2>"Fuzzers" are programs that generate random inputs to trigger failures in tested programs. They are easily deployed and have found numerous vulnerabilities in various programs. The last decade has seen a tremendous increase in fuzzing research [4].  <br /><br />In 2018, Chen and Chen published the paper "Angora: Efficient Fuzzing by Principled Search" [1] featuring a new gray box, mutation-based fuzzer called Angora. Angora presented extraordinary results in its effectiveness and shines with its stellar performance on the Lava-M benchmark [3], dramatically outperforming all competition.  <br /><br />The reason behind this breakthrough and leap in effectiveness towards deeper penetration of target programs was cited as the combination of four techniques: scalable byte-level taint tracking, context-sensitive branch count, input length exploration, and search based on gradient descent. The former three techniques had already been explored in earlier work; but the novel key contribution, as also indicated by the paper title, was the&nbsp;<em>Gradient Descent</em>&nbsp;approach to solve constraints modeling branch conditions as functions and approximating their gradient.  <br /><br />One of our students was intrigued by the outstanding performance and wanted to investigate why and how optimization strategies affect the fuzzing performance that much - with the initial goal of actually further improving on Angora. To properly measure the effect of his work, he went and worked directly on the Angora source code. During his study [2], he came across some confusing findings, which we summarize below. <br /><br /><h2>The Findings</h2><h3>Angora's Gradient Descent performs similar to Random Search on LAVA-M</h3>Contrary to what is stated in the Angora paper, we could not find real differences between using a random search algorithm and using Gradient descent to solve constraints. After further investigation, it turns out that in almost all optimization cycles, the constraint is solved immediately when the first input is executed. That first input is generated by using magic byte extraction – and only when it is replaced by a random starting point does the performance of Random Search drop off. Since 32-bit magic byte values comprise all of the bugs artificially injected into the LAVA benchmark, it does not surprise that this feature dominates the performance instead of Gradient Descent.<br /><div><br />Of course, this raises the question of why Angora is so successful. Magic byte extraction is not a new technique, but in the case of this benchmark, in combination with taint tracking, good heuristics, and other improvements it leads to spectacular results on LAVA-M. However, Gradient Descent contributed little to that success.</div><div><br />These findings are confirmed by Angora's authors [5]: "If the fuzzer can extract the magic bytes and copy them to the&nbsp;<em>correct</em>&nbsp;location in the input, then obviously the fuzzer can solve the constraint immediately." They point out that Gradient Descent will show and did show advantages outside of solving magic byte constraints, even if this is not their evaluation setting. And indeed, our findings do not imply that Gradient Descent would not work; on the contrary, we still find it a highly promising idea. However, whether and when it can make a difference is an open question.  <br /><br /><h3>The Angora Evaluation Methodology is Inadequate</h3>In the Angora paper, the authors claimed to have investigated the efficacy of each contribution individually and proved the effectiveness of Gradient Descent. Unfortunately, the comparison they present to support this claim is biased towards Gradient Descent. They tried to compare the constraint-solving capabilities of random search, random search with magic byte extraction and Gradient descent. They collected an input corpus using AFL and then started Angora with each algorithm and the same input corpus. This way, all algorithms start with the same set of constraints to solve and the authors reported the corresponding solve rate for each algorithm.&nbsp;</div><div>&nbsp; <br />Since AFL uses random mutations to solve constraints, it is not surprising that all constraints that can be easily solved with random mutations have been already solved in the input corpus. This gives random search an immediate disadvantage.&nbsp;</div><div>&nbsp; <br />While inspecting the code of Angora, we also found another issue. The evaluation ([1, Section 5.4]) states that Gradient Descent is compared to random search with Magic Byte extraction. However, the Angora Gradient Descent implementation itself makes use of Magic Byte Extraction, thus guaranteeing that it always performs&nbsp;<em>at least as</em>&nbsp;well as its closest competitor in the comparison. This methodology is inadequate and the original conclusions about the efficacy of Gradient Descent are not supported by our research.&nbsp;</div><div>&nbsp; <br />The Angora authors state that their "exploitation routines are a part of the enhancements aforementioned. During gradient descent, Angora first descends by the entire gradient. Only when this fails to solve the constraint does Angora try to descend by each partial derivative as a crude attempt of salvation." [5] According to our findings, however, these heuristics dominate the search of Gradient Descent for constraints with a large number of input dimensions – a fact that should have been discovered in an adequate evaluation setting.  <br /><br /><h3>Odd Heuristics and Parameters</h3>The Angora code contains a number of optimizations and behaviors that are not documented in the paper. While the volume of information that can be published in a paper is limited, many of these had a significant impact on the potential performance; yet, they are not documented or motivated in the released source code. These are some examples: <br /><ul><li>The&nbsp;<a href="https://github.com/AngoraFuzzer/Angora/blob/master/fuzzer/src/search/gd.rs" title="https://github.com/AngoraFuzzer/Angora/blob/master/fuzzer/src/search/gd.rs">Gradient Descent implementation</a>&nbsp;goes beyond what is described in the paper. It contains special exploitation routines that inject fixed values that are known to trigger overflows and numerical bugs. The algorithm also does not only use the entire gradient but instead descends by each partial derivative. </li><li>Parameters like the optimization budget are set to fixed, arbitrary values without justification or documentation for the&nbsp;<a href="https://github.com/AngoraFuzzer/Angora/blob/master/common/src/config.rs" title="https://github.com/AngoraFuzzer/Angora/blob/master/common/src/config.rs">chosen parameters</a>:  <pre style="background-color: rgba(220, 220, 220, 0.4); border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-top-left-radius: 3px; border-top-right-radius: 3px; font-size: 14px; font-variant-ligatures: normal; orphans: 2; overflow: auto; padding: 16px; white-space: pre-wrap; widows: 2;"><code class="code-line language-Rust code-line language-Rust" data-line="89" style="color: var(--vscode-editor-foreground); font-family: Menlo, Monaco, Consolas, &quot;Droid Sans Mono&quot;, &quot;Courier New&quot;, monospace, &quot;Droid Sans Fallback&quot;; font-size: 1em; line-height: 1.357em; position: relative; tab-size: 4;"><span class="hljs-comment" style="color: green; font-style: italic;">// SEARCH</span><br /><span class="hljs-keyword" style="color: blue;">pub</span> <span class="hljs-keyword" style="color: blue;">const</span> ENABLE_DET_MUTATION: <span class="hljs-built_in" style="color: blue;">bool</span> = <span class="hljs-literal" style="color: #a31515;">true</span>;<br /><span class="hljs-keyword" style="color: blue;">pub</span> <span class="hljs-keyword" style="color: blue;">const</span> MAX_SEARCH_EXEC_NUM: <span class="hljs-built_in" style="color: blue;">usize</span> = <span class="hljs-number" style="color: #b8d7a3;">376</span>;<br /><span class="hljs-keyword" style="color: blue;">pub</span> <span class="hljs-keyword" style="color: blue;">const</span> MAX_EXPLOIT_EXEC_NUM: <span class="hljs-built_in" style="color: blue;">usize</span> = <span class="hljs-number" style="color: #b8d7a3;">66</span>;<br /><span class="hljs-keyword" style="color: blue;">pub</span> <span class="hljs-keyword" style="color: blue;">const</span> MAX_NUM_MINIMAL_OPTIMA_ROUND: <span class="hljs-built_in" style="color: blue;">usize</span> = <span class="hljs-number" style="color: #b8d7a3;">8</span>;<br /><span class="hljs-keyword" style="color: blue;">pub</span> <span class="hljs-keyword" style="color: blue;">const</span> MAX_RANDOM_SAMPLE_NUM: <span class="hljs-built_in" style="color: blue;">usize</span> = <span class="hljs-number" style="color: #b8d7a3;">10</span>;<br /><span class="hljs-keyword" style="color: blue;">pub</span> <span class="hljs-keyword" style="color: blue;">const</span> GD_MOMENTUM_BETA: <span class="hljs-built_in" style="color: blue;">f64</span> = <span class="hljs-number" style="color: #b8d7a3;">0.0</span>;<br /><span class="hljs-keyword" style="color: blue;">pub</span> <span class="hljs-keyword" style="color: blue;">const</span> GD_ESCAPE_RATIO: <span class="hljs-built_in" style="color: blue;">f64</span> = <span class="hljs-number" style="color: #b8d7a3;">1.0</span>;<br /><span class="hljs-keyword" style="color: blue;">pub</span> <span class="hljs-keyword" style="color: blue;">const</span> BONUS_EXEC_NUM: <span class="hljs-built_in" style="color: blue;">usize</span> = <span class="hljs-number" style="color: #b8d7a3;">66</span>;<br /></code></pre><br /> Values like&nbsp;<code style="color: var(--vscode-textPreformat-foreground); font-family: Menlo, Monaco, Consolas, &quot;Droid Sans Mono&quot;, &quot;Courier New&quot;, monospace, &quot;Droid Sans Fallback&quot;; font-size: 1em; line-height: 1.357em;">MAX_SEARCH_EXEC_NUM</code>&nbsp;(376; the number of iterations to solve a constraint) or&nbsp;<code style="color: var(--vscode-textPreformat-foreground); font-family: Menlo, Monaco, Consolas, &quot;Droid Sans Mono&quot;, &quot;Courier New&quot;, monospace, &quot;Droid Sans Fallback&quot;; font-size: 1em; line-height: 1.357em;">BONUS_EXEC_NUM</code>&nbsp;(66; the number of additional iterations added under certain conditions) would be odd choices in an experiment design; computer scientists would normally prefer multiples of powers of 10, 2, or 5. These choices are not justified or documented; and in any case, the impact of these choices (compared to others) would have to be determined.  <br /> The value of 376 for&nbsp;<code style="color: var(--vscode-textPreformat-foreground); font-family: Menlo, Monaco, Consolas, &quot;Droid Sans Mono&quot;, &quot;Courier New&quot;, monospace, &quot;Droid Sans Fallback&quot;; font-size: 1em; line-height: 1.357em;">MAX_SEARCH_EXEC_NUM</code>&nbsp;is a particularly odd choice. Since the few constraints that Gradient Descent operated on were actually either solved after a maximum of 50 iterations or not at all, setting the iteration budget to at most 50 should actually increase the performance on LAVA-M.</li></ul>The Angora authors confirm that the "current values seem to work well on most programs, but we did not rigorously evaluate them or search for their optimal values." [5] This implies that the authors themselves do not know which factors contribute to Angora's evaluation performance, or why their choices would be particularly well suited to settings outside of the evaluation.  <br /><br /><h3>Reproducibility</h3>All of the above findings refer to the&nbsp;<em>published Angora code</em>, which may differ from the one used in the paper evaluation. We have therefore asked the Angora authors to provide us with the version used for the experiments described in the paper. They said that they "have been steadily maintaining and improving the Angora repository over the past year, with numerous bug fixes and enhancements. Its current performance is similar to, if not better than, the version on which our paper's evaluation was based." Unfortunately, the history of the public repository does not go back to the time the paper was published, and our request for the original version remains unfulfilled. We do not know whether the Angora authors would be able to reproduce their published results.  <br /><h2>Summary</h2>The performance and effectiveness of the Angora tool are uncontested, notably on the LAVA-M benchmark. If you want to fuzz a program that is part of the LAVA-M benchmark or very similar, Angora is likely to give you good results. Finally, the authors are to be commended for making their code available, and for providing detailed and timely answers to our questions.  However, <br /><ol><li>Angora's novel Gradient Descent approach has little to no impact on its performance on LAVA-M;</li><li>The performance of Angora is impacted by several decisions that are not documented, motivated, assessed, or evaluated individually or sufficiently; and</li><li>The evaluation methodology is inadequate to support the paper's conclusions on Angora's performance.</li></ol>Guidelines for good scientific practice mandate that all information and decisions that helped to achieve a specific result be well documented. This is not the case here – neither in the paper nor in the code.</div><div><br />It would be a mistake, however, to point at the Angora authors only. Chen and Chen&nbsp;<em>did</em> make their code available, allowing for independent assessment. Several recent fuzzing papers use similar techniques and benchmarks as Angora,&nbsp;<em>yet only few make their code available</em>. Can we trust their results?</div><div><br />This calls for the community to discuss and question its procedures and criteria on what makes good research. Reviewers and researchers must not only focus on great results, but also assess how these results have been obtained, whether they have been rigorously evaluated, and how they translate into insights that will stand the test of time. How this can be achieved for programs with thousands of lines of undocumented code is a pressing question.</div><div><br />For now, the Angora case tells us how much we do&nbsp;<em>not</em>&nbsp;know, and how much further insights into what works and what does not will be needed. The good news is that this opens lots of opportunities for discussion – and future research.<br /><br /><br /><i><b>Acknowledgments.</b> &nbsp;Marcel Böhme, Cas Cremers, Thorsten Holz, Mathias Payer, and Ben Stock provided helpful feedback on earlier revisions of this post. &nbsp;Thanks a lot!</i><br /><i><br /></i><i>If you liked this post, also see our <a href="https://andreas-zeller.blogspot.com/2019/10/when-results-are-all-that-matters.html" target="_blank">follow-up post</a> with consequences.</i><br /><i><br /></i><i>You can contact Kai Greshake as <a href="mailto:development@kai-greshake.de">development@kai-greshake.de</a>.</i><br /><i><br /></i><br /><h2>References</h2><ul><li>[1] P. Chen and H. Chen, "<a href="https://ieeexplore.ieee.org/document/8418633" title="https://ieeexplore.ieee.org/document/8418633">Angora: Efficient Fuzzing by Principled Search</a>." 2018 IEEE Symposium on Security and Privacy (IEEE S&amp;P), San Francisco, CA, 2018, pp. 711-725.</li><li>[2] K. Greshake, “<a href="https://www.dropbox.com/s/43ovybqfiugen1w/thesis_greshake.pdf?dl=0" title="https://www.dropbox.com/s/43ovybqfiugen1w/thesis_greshake.pdf?dl=0">Effective Search Algorithms for Grey Box Fuzzing</a>” BSc. Thesis at Saarland University, August 2019.</li><li>[3] B. Dolan-Gavitt et al., "<a href="https://ieeexplore.ieee.org/document/7546498" title="https://ieeexplore.ieee.org/document/7546498">LAVA: Large-Scale Automated Vulnerability Addition</a>," 2016 IEEE Symposium on Security and Privacy (IEEE S&amp;P), San Jose, CA, 2016, pp. 110-121.</li><li>[4] Valentin J.M. Manes, HyungSeok Han, Choongwoo Han, Sang Kil Cha, Manuel Egele, Edward J. Schwartz, Maverick Woo, "<a href="https://arxiv.org/abs/1812.00140" title="https://arxiv.org/abs/1812.00140">The Art, Science, and Engineering of Fuzzing: A Survey</a>". arXiv:1812.00140</li><li>[5] P. Chen, H. Chen, A. Zeller. "<a href="https://www.dropbox.com/s/qku87fw3fmwdw95/angora_exchange.pdf?dl=0" title="https://www.dropbox.com/s/qku87fw3fmwdw95/angora_exchange.pdf?dl=0">Questions on Angora tool vs Angora paper</a>". E-mail exchange, September/October 2019.</li></ul><br /><br /><br /><br /><br /></div>